name: Blockchain Contracts CI

on:
  workflow_dispatch:
  merge_group:
  pull_request:
    branches:
      - main
      - release/**
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  NODE_VERSION: '22.x'

jobs:
  changes:
    name: Detect contracts changes
    runs-on: ubuntu-latest
    outputs:
      contracts_changed: ${{ steps.changed.outputs.contracts_changed }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0

      - name: Determine if contracts changed
        id: changed
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "contracts_changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            base_sha="${{ github.event.pull_request.base.sha }}"
            head_sha="${{ github.event.pull_request.head.sha }}"
          elif [[ "${{ github.event_name }}" == "merge_group" ]]; then
            base_sha="${{ github.event.merge_group.base_sha }}"
            head_sha="${{ github.event.merge_group.head_sha }}"
          else
            echo "contracts_changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if git diff --name-only "$base_sha" "$head_sha" | grep -q '^contracts/'; then
            echo "contracts_changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "contracts_changed=false" >> "$GITHUB_OUTPUT"
          fi

  contracts:
    name: Contracts lint, compile, and tests
    needs: [changes]
    runs-on: ubuntu-latest
    if: (github.event_name != 'pull_request' || github.event.pull_request.draft == false) && needs.changes.outputs.contracts_changed == 'true'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Get yarn cache directory path
        id: yarn-cache-dir-path
        run: echo "dir=$(yarn cache dir)" >> $GITHUB_OUTPUT

      - name: Restore yarn cached
        id: cache-yarn-restore
        uses: actions/cache/restore@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5
        with:
          path: |
            ${{ steps.yarn-cache-dir-path.outputs.dir }}
            node_modules
          key: ${{ runner.os }}-${{ env.NODE_VERSION }}-yarn-${{ hashFiles('yarn.lock') }}

      - name: Setup Token
        run: echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" > .npmrc

      - name: Install Dependencies
        run: yarn install --frozen-lockfile --prefer-offline

      - name: Save yarn cache
        if: steps.cache-yarn-restore.outputs.cache-hit != 'true'
        uses: actions/cache/save@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5
        with:
          path: |
            ${{ steps.yarn-cache-dir-path.outputs.dir }}
            node_modules
          key: ${{ runner.os }}-${{ env.NODE_VERSION }}-yarn-${{ hashFiles('yarn.lock') }}

      - name: Lint Contracts
        run: yarn contracts:lint

      - name: Compile Contracts (Hardhat)
        run: yarn contracts:build:hardhat

      - name: Start Besu Blockchain Node
        run: >
          docker run
          --name blockchain
          -p 8545:8545
          -v ./eng/docker/services/blockchain-config:/opt/besu/config
          -d
          hyperledger/besu:25.4.1@sha256:00468488df234ead7c0e450ffcd5bc1ac3ed62f458a0de42ba029155ecdf5331
          --genesis-file=/opt/besu/config/genesis.json
          --node-private-key-file=/opt/besu/config/key
          --rpc-http-enabled
          --rpc-http-api=ETH,NET,WEB3
          --host-allowlist=*
          --rpc-http-cors-origins=all
          --min-gas-price=0
          --profile=enterprise

      - name: Wait for Besu RPC
        run: while ! nc -z localhost 8545; do echo "Waiting for Besu on 8545..."; sleep 2; done;

      - name: Run Contracts Tests
        run: yarn contracts:test
