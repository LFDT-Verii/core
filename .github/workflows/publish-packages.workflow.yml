name: Publish Packages
on:
  push:
    branches: [ main ]
    paths:
      - 'packages/**'
      - 'servers/**'
      - 'tools/**'
  workflow_dispatch:
    inputs:
      version-type:
        type: choice
        description: Choose environment
        default: 'prerelease'
        options: 
        - prerelease
        - release
env:
  LERNA_VERSION: '9.0.3'
  DIST_TAG: 'prerelease'
  NODE_VERSION: '22.x'
  VERSION_TYPE: ${{ github.event_name == 'workflow_dispatch' && inputs.version-type || format('{0}', 'prerelease') }}
  TARGET_ORG: 'verii'
  CURR_REPO_VERSION: '1.1.0'
jobs:
  # Publish Packages
  publish-packages:
    name: Publish Packages
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    steps:
      # Checkout Repository
      - name: Checkout Repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0 # Recommended for Lerna to track history
      # Generate PreRelease Version Number
      - name: Generate PreRelease Version Number
        run: echo "PRERELEASE_VER_NUM=${{format('{0}-pre.$(date +%s)', env.CURR_REPO_VERSION)}}" >> $GITHUB_ENV
      # Set Npm Version Number
      - name: Set Npm Version Number
        run: echo "NPM_VER_NUM=${{ env.VERSION_TYPE == 'release' && env.CURR_REPO_VERSION || env.PRERELEASE_VER_NUM }}" >> $GITHUB_ENV
      # Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'
      - name: Enable Corepack
        run: corepack enable
      # Get pnpm store path
      - name: Get pnpm store path
        id: pnpm-store-path
        run: echo "dir=$(pnpm store path)" >> $GITHUB_OUTPUT
      # Restore pnpm cache
      - name: Restore pnpm cache
        id: cache-pnpm-restore
        uses: actions/cache/restore@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5
        with:
          path: |
            ${{ steps.pnpm-store-path.outputs.dir }}
            node_modules
          key: ${{ runner.os }}-${{ env.NODE_VERSION }}-pnpm-${{ hashFiles('pnpm-lock.yaml') }}
      # Install Dependencies
      - name: Install Dependencies
        run: pnpm install --frozen-lockfile
      # Set Version
      - name: Set Version
        run: pnpm dlx lerna@${{ env.LERNA_VERSION }} version --no-git-tag-version --no-push --exact --yes ${{ env.NPM_VER_NUM }}
      # Git Set Identity
      - name: Git Identity
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
      # Set Dist Tag For Release
      - name: Set Dist Tag For Release
        run: echo 'DIST_TAG=latest' >> $GITHUB_ENV
        if: env.VERSION_TYPE == 'release'
      # Commit Version Locally for Npmjs
      - name: Commit Version Locally for Npmjs
        run: git commit -am "Creating Version ${{ env.NPM_VER_NUM }}"
      # Publish to NpmJS with trusted publishing (OIDC + provenance)
      # Lerna v9+ has native support for npm trusted publishing
      # See: https://lerna.js.org/docs/features/version-and-publish
      - name: Publish NpmJS
        run: pnpm dlx lerna@${{ env.LERNA_VERSION }} publish --dist-tag ${{ env.DIST_TAG }} from-package --yes --registry "https://registry.npmjs.org/"
        env:
          NPM_CONFIG_PROVENANCE: true
